#!/bin/sh
# Splits each line of my bookmarks file into an option to be passed into dmenu,
# the selected value in dmenu is used to load up a new window/tab in the selected
# browser

CONFIG_FOLDER=~/.config/bookmenus

DEFAULTVERTICALLINES=""
DEFAULTMONITOR=""
DEFAULTFONT="Mono-12"
DEFAULTBACKGROUNDCOLOR="#1d1f21"
DEFAULTSELECTEDBACKGROUNDCOLOR="#444"
DEFAULTFOREGROUNDCOLOR="#d8dee9"
DEFAULTSELECTEDFOREGROUNDCOLOR="#268bd2"
DEFAULTSEPERATOR=":"
DEFAULTBOOKMARKS=~/.config/bookmenu/bookmarks
DEFAULTCONFIG=~/.config/bookmenu/config
DEFAULTCOMMAND="$BROWSER"
DEFAULTPROMPT="Select a bookmark"
DEFAULT_FUZZY_FINDER="dmenu"
DEFAULT_BOOKMARKS="duckduckgo:duckduckgo.com
ebay:www.ebay.com
paypal:www.paypal.com
amazon:www.amazon.com
youtube:www.youtube.com
wikipedia:www.wikipedia.com
github:www.github.com
reddit:www.reddit.com"
DEFAULT_CONFIGS="# Sets the fuzzy finder to use, currently supported options are fzf and dmenu
# default: dmenu
# FUZZY_FINDER=dmenu

# Sets the prompt text used by the fuzzy finder prompt
# PROMPT_TEXT=Select a bookmark

# The monitor to display the prompt on, leave blank to use primary monitor only
# works in dmenu mode
# MONITOR=

# Sets the background color of the dmenu prompt
# BACKGROUND_COLOR=#1d1f21

# Sets the forground color unselected items in the dmenu prompt
# FOREGROUND_COLOR=$d8dee9

# Sets the background of the selected items in the dmenu prompt
# SELECTED_BACKGROUND_COLOR=#444

# Sets the foreground color of the selected item in the dmenu prompt
# SELECTED_FOREGROUND_COLOR=#268bd2

# Sets the font used by the dmenu prompt
#FONT=Mono-12

# Sets the seperator to be used to split the names and the paths in the bookmark files
#SEPERATOR=:

# Leave this value unset to use a horizontal dmenu prompt, set it to a number to use a vertical prompt
#VERTICAL_LINES=

# Sets the location of the bookmarks file
# BOOKMARKS_LOCATION=~/.config/bookmenu/bookmarks

# Sets the command used to open a bookmark with
# COMMAND=$BROWSER
"

LASTOPTION=""

helppage() {
  echo "Future Help Page"
}

options='\-(m|l|p|fn|nb|sb|sf|co|c|b|sp|f|a|r)'

# Handles the parsing of options to check if they're valid
handleoption() {
  if echo "$1" | grep -Eq $options; then
    if [ -z "$LASTOPTION" ]; then
      LASTOPTION=$var
    elif echo "$LASTOPTION" | grep -Eq $options ; then
      echo "$LASTOPTION requires an argument" && exit
    fi
  elif echo "$1" | grep -Eq '\-h'; then
    helppage
    exit
  elif echo "$1" | grep -Eq '\-o'; then
    ECHO_PATH="true"
  elif echo "$1" | grep -Eq '\-(g|gc|gb)'; then
    # Completely regenerate configs
    if [ $1 = "-g" ]; then
      if [ -d $CONFIG_FOLDER ]; then
        rm -rf $CONFIG_FOLDER
        mkdir $CONFIG_FOLDER
        echo "$DEFAULT_CONFIGS" > $CONFIG_FOLDER/config
        echo "$DEFAULT_BOOKMARKS" > $CONFIG_FOLDER/bookmarks
      else
        mkdir $CONFIG_FOLDER
        echo "$DEFAULT_CONFIGS" > $CONFIG_FOLDER/config
        echo "$DEFAULT_BOOKMARKS" > $CONFIG_FOLDER/bookmarks
      fi
    # Regenerate config file
    elif [ $1 = "-gc" ]; then
      if [ -d $CONFIG_FOLDER ]; then
        echo "$DEFAULT_CONFIGS" > $CONFIG_FOLDER/config
      else
        mkdir $CONFIG_FOLDER
        echo "$DEFAULT_CONFIGS" > $CONFIG_FOLDER/config
      fi
    # Regenerate bookmarks file
    else
      if [ -d $CONFIG_FOLDER ]; then
        echo "$DEFAULT_CONFIGS" > $CONFIG_FOLDER/config
      else
        mkdir $CONFIG_FOLDER
        echo "$DEFAULT_CONFIGS" > $CONFIG_FOLDER/config
        echo "$DEFAULT_BOOKMARKS" > $CONFIG_FOLDER/bookmarks
      fi
    fi
  else
    echo "Invalid option"
    exit
  fi
}

# Handles the assignment of arguments to the previous option passed in
handleargument() {
  if [ ! -z $LASTOPTION ]; then
    case "$LASTOPTION" in
      -l) VERTICALLINES="$1" ;;
      -m) MONITOR="$1" ;;
      -p) PROMPT="$1" ;;
      -fn) FONT="$1" ;;
      -nb) BACKGROUNDCOLOR="$1" ;;
      -nf) FOREGROUNDCOLOR="$1" ;;
      -sb) SELECTEDBACKGROUNDCOLOR="$1" ;;
      -sf) SELECTEDFOREGROUNDCOLOR="$1" ;;
      -b) BOOKMARKS="$1" ;;
      -c) CONFIG="$1" ;;
      -co) COMMAND="$1" ;;
      -sp) SEPERATOR="$1" ;;
      -f) FUZZY_FINDER="$1" ;;
      -a) ADD="$1" ;;
      -r) REMOVE="$1" ;;
      *) echo "Invalid option"
  esac
  else
    echo "No option to assign this argument to"
    exit
  fi
  LASTOPTION=""
}

# Loop through each value passed in
for var in "$@"
do
  case "$var" in
    -*) handleoption "$var" ;;
    *) handleargument "$var" ;;
  esac
done

if [ -z $CONFIG ]; then CONFIG=$DEFAULTCONFIG; fi

# Handle the assignment of config values
while read line; do
  value=$(echo $line | sed "s/.*=//")
  case "$line" in
    VERTICAL_LINES=*) VERTICALLINES=$value ;;
    MONITOR=*) MONITOR=$value ;;
    FONT=*) FONT=$value ;;
    BACKGROUND_COLOR=*) BACKGROUNDCOLOR=$value ;;
    SELECTED_BACKGROUND_COLOR=*) SELECTEDBACKGROUNDCOLOR=$value ;;
    FOREGROUND_COLOR=*) FOREGROUNDCOLOR=$value ;;
    SELECTED_FOREGROUND_COLOR=*) SELECTEDFOREGROUNDCOLOR=$value ;;
    SEPERATOR=*) SEPERATOR=$value ;;
    BOOKMARKS_LOCATION=*) BOOKMARKS=$value ;;
    COMMAND=*) COMMAND=$value ;;
    PROMPT_TEXT=*) PROMPT=$value ;;
    FUZZY_FINDER=*) FUZZY_FINDER=$value ;;
  esac
done < $CONFIG

# Fill in any blank spots with default values
if [ -z "$VERTICALLINES" ]; then VERTICALLINES="$DEFAULTVERTICALLINES"; fi
if [ -z "$MONITOR" ]; then MONITOR="$DEFAULTMONITOR"; fi
if [ -z "$FONT" ]; then FONT="$DEFAULTFONT"; fi
if [ -z "$BACKGROUNDCOLOR" ]; then BACKGROUNDCOLOR="$DEFAULTBACKGROUNDCOLOR"; fi
if [ -z "$SELECTEDBACKGROUNDCOLOR" ]; then SELECTEDBACKGROUNDCOLOR="$DEFAULTSELECTEDBACKGROUNDCOLOR"; fi
if [ -z "$FOREGROUNDCOLOR" ]; then FOREGROUNDCOLOR="$DEFAULTFOREGROUNDCOLOR"; fi
if [ -z "$SELECTEDFOREGROUNDCOLOR" ]; then SELECTEDFOREGROUNDCOLOR="$DEFAULTSELECTEDFOREGROUNDCOLOR"; fi
if [ -z "$SEPERATOR" ]; then SEPERATOR="$DEFAULTSEPERATOR"; fi
if [ -z "$BOOKMARKS" ]; then BOOKMARKS="$DEFAULTBOOKMARKS"; fi
if [ -z "$COMMAND" ]; then COMMAND="$DEFAULTCOMMAND"; fi
if [ -z "$PROMPT" ]; then PROMPT="$DEFAULTPROMPT"; fi
if [ -z "$FUZZY_FINDER" ]; then FUZZY_FINDER="$DEFAULT_FUZZY_FINDER"; fi

# Opens the selected fuzzy finder with the options set
fuzzy_find() {
  case "$FUZZY_FINDER" in
    dmenu) dmenu -i -p "$PROMPT" -fn "$FONT" -l "$VERTICALLINES" -m "$MONITOR" -nb "$BACKGROUNDCOLOR" -nf "$FOREGROUNDCOLOR" -sb "$SELECTEDBACKGROUNDCOLOR" -sf "$SELECTEDFOREGROUNDCOLOR" ;;
    fzf) fzf ;;
    *) echo "$FUZZY_FINDER in not a supported fuzzy finder"
esac
}

# Selects the path based on the name
select_path() {
  xargs -I % grep "%$SEPERATOR" $BOOKMARKS | sed "s/.*$SEPERATOR//;"
}

# Handle urls to the file system
filesystem() {
  if case $bookmark in ~/*) ;; *) false;; esac; then
    $COMMAND $bookmark &
  else
    fullpath="$HOME/$(echo $bookmark | sed "s/~\///")"
    $COMMAND $fullpath &
  fi
}

# Handle urls to a website
website() {
  $COMMAND $bookmark &
}

# Add new bookmark
if [ ! -z $ADD ]; then
  echo "$ADD" >> $BOOKMARKS
# Remove bookmark
elif [ ! -z $REMOVE ]; then
  sed -i "/$REMOVE:/d" $BOOKMARKS
# Echo the path of selected file
elif [ ! -z $ECHO_PATH ]; then
  echo "$bookmark"
# Normal operation
else
  bookmark=$(sort $BOOKMARKS | sed "s/$SEPERATOR.*//" | fuzzy_find | select_path)
  if [ -z $bookmark ]; then
    echo "No bookmark selected"
    exit
  fi

  case "$bookmark" in
    ~\/*|\/*) filesystem ;;
    *) website ;;
  esac
fi
